<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Trading Dashboard</title>
  <link rel="stylesheet" href="/static/style.css"/>
  <!-- Chart.js & plugins -->
  <script src="https://cdn.jsdelivr.net/npm/luxon@1.28.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.0"></script>

  <!-- âœ… ê³µì‹ ìº”ë“¤ í”ŒëŸ¬ê·¸ì¸ CDN -->
  <script src="https://www.chartjs.org/chartjs-chart-financial/chartjs-chart-financial.js"></script>
</head>
<body>
  <div class="layout">
    <h1>
      ğŸ“ˆ Trading Dashboard
      {% if region != 'ALL' %}
        <span class="region-pill">{{ region }}</span>
      {% endif %}
    </h1>
    <div class="region-tabs">
      <a href="/?region=ALL" class="region-tab {% if region == 'ALL' %}active{% endif %}">
        ì „ì²´
      </a>
      <a href="/?region=KR" class="region-tab {% if region == 'KR' %}active{% endif %}">
        KR
      </a>
      <a href="/?region=US" class="region-tab {% if region == 'US' %}active{% endif %}">
        US
      </a>
      <a href="/?region=CR" class="region-tab {% if region == 'CR' %}active{% endif %}">
        CR
      </a>
    </div>
    <!-- ìš”ì•½ ì¹´ë“œ -->
    <p style="font-size:12px; color:#9da4c2; margin-bottom:8px;">
      ë³´ê¸°: 
      {% if region == 'ALL' %}ì „ì²´ ì‹œì¥ (KR + US + CR ê¸°ì¤€){% endif %}
      {% if region == 'KR' %}êµ­ë‚´ ì£¼ì‹ (KR){% endif %}
      {% if region == 'US' %}ë¯¸êµ­ ì£¼ì‹ (US){% endif %}
      {% if region == 'CR' %}ì½”ì¸ (CR){% endif %}
    </p>
    <div class="summary-grid">
      <div class="card">
        <div class="summary-item-title">ì´ íŠ¸ë ˆì´ë“œ ìˆ˜</div>
        <div class="summary-item-value">{{ summary.total_trades }}</div>
      </div>
      <div class="card">
        <div class="summary-item-title">ìŠ¹ë¥  (%)</div>
        <div class="summary-item-value {% if summary.win_rate >= 50 %}pill-positive{% else %}pill-negative{% endif %}">
          {{ "%.2f"|format(summary.win_rate) }}
        </div>
      </div>
      <div class="card">
        <div class="summary-item-title">íŠ¸ë ˆì´ë“œë‹¹ í‰ê·  ìˆ˜ìµë¥  (%)</div>
        <div class="summary-item-value {% if summary.avg_profit >= 0 %}pill-positive{% else %}pill-negative{% endif %}">
          {{ "%.2f"|format(summary.avg_profit) }}
        </div>
      </div>
      <div class="card">
        <div class="summary-item-title">ëˆ„ì  ìˆ˜ìµë¥  (%)</div>
        <div class="summary-item-value {% if summary.cum_return_pct >= 0 %}pill-positive{% else %}pill-negative{% endif %}">
          {{ "%.2f"|format(summary.cum_return_pct) }}
        </div>
      </div>
    </div>
    <li class="nav-item">
      <button class="nav-link" id="tab-btn-ai-report" data-tab="ai-report">
        ğŸ¤– AI ë¦¬í¬íŠ¸
      </button>
    </li>

    <!-- íƒ­ ë‚´ìš© -->
    <div id="tab-ai-report" class="tab-pane" style="display:none;">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span id="ai-report-date">AI ë¦¬í¬íŠ¸</span>
          <small id="ai-report-created-at" class="text-muted"></small>
        </div>

        <div class="card-body" style="display:flex; gap: 20px; flex-wrap: wrap;">

          <!-- 1) ì¼ì¼ íŠ¸ë ˆì´ë“œ ë¦¬í¬íŠ¸ -->
          <div style="flex:1 1 30%; min-width:280px; max-width: 33%;">
            <h5>ğŸ“Š ì¼ì¼ íŠ¸ë ˆì´ë“œ ë¦¬í¬íŠ¸</h5>
            <pre id="ai-daily-report"
                style="white-space:pre-wrap; max-height:400px; overflow:auto; font-size:0.9rem;"></pre>
          </div>

          <!-- 2) ì „ëµ ì•„ì´ë””ì–´ ë¸Œë ˆì¸ìŠ¤í† ë° -->
          <div style="flex:1 1 30%; min-width:280px; max-width: 33%;">
            <h5>ğŸ§  ì „ëµ ì•„ì´ë””ì–´ ë¸Œë ˆì¸ìŠ¤í† ë°</h5>
            <pre id="ai-strategy-ideas"
                style="white-space:pre-wrap; max-height:400px; overflow:auto; font-size:0.9rem;"></pre>
          </div>

          <!-- 3) ëª¨ë¸ ì—…ë°ì´íŠ¸ / íŠœë‹ ì¡°ì–¸ -->
          <div style="flex:1 1 30%; min-width:280px; max-width: 33%;">
            <div class="d-flex justify-content-between align-items-center">
              <h5>ğŸ›  ëª¨ë¸ ì—…ë°ì´íŠ¸ / íŠœë‹ ì¡°ì–¸</h5>
              <small id="ai-model-advice-date" class="text-muted"></small>
            </div>
            <pre id="ai-model-advice"
                style="white-space:pre-wrap; max-height:400px; overflow:auto; font-size:0.9rem;"></pre>
          </div>

        </div>
      </div>
    </div>

        <!-- ì˜¤ëŠ˜ì˜ ML í•™ìŠµ ìš”ì•½ & ê°œì„ ì•ˆ -->
    <div class="section">
      <div class="card">
        <h2>ğŸ¤– ì˜¤ëŠ˜ì˜ ML í•™ìŠµ ìš”ì•½ & ê°œì„  ì œì•ˆ</h2>
        {% if suggestions and suggestions|length > 0 %}
          <ul class="suggest-list">
            {% for s in suggestions %}
              <li>{{ s }}</li>
            {% endfor %}
          </ul>
        {% else %}
          <p style="font-size:13px; color:#9da4c2; margin-top:6px;">
            ì˜¤ëŠ˜ì€ ì•„ì§ ë¶„ì„í•  ì‹ í˜¸ê°€ ì¶©ë¶„íˆ ì—†ìŠµë‹ˆë‹¤. ì¥ ë§ˆê° í›„ ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”.
          </p>
        {% endif %}
      </div>
    </div>
    <!-- AI ì˜ì‚¬ê²°ì • ë¡œê·¸ -->
    <div class="section">
      <div class="card">
        <h2>ğŸ¤– AI ì˜ì‚¬ê²°ì • ë¡œê·¸ (ìµœê·¼ 200ê°œ ì‹ í˜¸)</h2>
        <div class="scroll-box">
          <table>
            <thead>
              <tr>
                <th>ì‹œê°„</th>
                <th>ì‹œì¥</th>
                <th>ì¢…ëª©</th>
                <th>ê°€ê²©</th>
                <th>ë£°ì‹ í˜¸</th>
                <th>ML ì ìˆ˜</th>
                <th>ì§„ì…í—ˆìš©</th>
                <th>ë³´ìœ ì¤‘</th>
                <th>ë¹„ê³ </th>
              </tr>
            </thead>
            <tbody>
              {% for s in signals %}
              <tr>
                <td>{{ s.time }}</td>
                <td>{{ s.region }}</td>
                <td>{{ s.symbol }}</td>
                <td>{{ "%.2f"|format(s.price) }}</td>
                <td>{% if s.entry_signal %}âœ…{% else %}âŒ{% endif %}</td>
                <td>
                  {% if s.ml_proba is not none %}
                    {{ "%.3f"|format(s.ml_proba) }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td>
                  {% if s.entry_allowed is none %}
                    -
                  {% elif s.entry_allowed %}
                    âœ…
                  {% else %}
                    âŒ
                  {% endif %}
                </td>
                <td>{% if s.has_stock %}ë³´ìœ {% else %}-{% endif %}</td>
                <td>{{ s.note }}</td>
              </tr>
              {% endfor %}
              {% if signals|length == 0 %}
              <tr><td colspan="9">ì•„ì§ ê¸°ë¡ëœ ì‹ í˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="log-section">
            <!-- ì‹¤í–‰ ë¡œê·¸ -->
      <div class="card py-log">
        <h2>ğŸ“ ì‹¤í–‰ ë¡œê·¸ (ìµœê·¼ 200ê°œ)</h2>
        <div class="scroll-box">
          <table>
            <thead>
              <tr>
                <th>ì‹œê°„</th>
                <th>ë©”ì‹œì§€</th>
              </tr>
            </thead>
            <tbody>
              {% for log in logs %}
              <tr>
                <td>{{ log.time }}</td>
                <td>{{ log.message }}</td>
              </tr>
              {% endfor %}
              {% if logs|length == 0 %}
              <tr><td colspan="2">ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
            <!-- ì‹¤íŒ¨ ë‚´ì—­ì´ ìˆì„ ë•Œë§Œ í‘œì‹œ -->
      {% if universe_failures %}
        <div class="card universe-failures">
          <h2>Recent backfill issues</h2>
          <div class="scroll-box">
            <ul>
              {% for f in universe_failures %}
                <li>
                  <span class="fail-time">[{{ f.created_at }}]</span>
                  <span class="fail-tag">{{ f.region }} {{ f.symbol }}</span>
                  <span class="fail-type">{{ f.error_type }}</span>
                  <span class="fail-msg">{{ f.error_message }}</span>
                </li>
              {% endfor %}
            </ul>
          </div>
        </div>
      {% endif %}
    </div>
    <!-- íŠ¸ë ˆì´ë“œ ë‚´ì—­ -->
    <div class="card section">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; gap:12px; flex-wrap:wrap;">
        <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
          <h2 style="margin:0;">ğŸ“‘ íŠ¸ë ˆì´ë“œ</h2>

          {% if daily_summaries and daily_summaries|length > 0 %}
          <select id="trade-date-select" class="trade-date-select">
            <option value="ALL">ì „ì²´ ê¸°ê°„</option>
            {% for d in daily_summaries %}
            <option value="{{ d.date }}" {% if loop.first %}selected{% endif %}>
              {{ d.date }} ({{ d.total_trades }}ê±´)
            </option>
            {% endfor %}
          </select>
          {% endif %}
        </div>

        <div class="trade-date-summary">
          <span id="trade-date-label">-</span> Â·
          íŠ¸ë ˆì´ë“œ <strong id="trade-date-total">0</strong>ê±´ Â·
          ìŠ¹ë¥  <strong id="trade-date-winrate">0%</strong> Â·
          í‰ê·  <strong id="trade-date-avg">0%</strong> Â·
          ëˆ„ì  <strong id="trade-date-cum">0%</strong>
        </div>
        <button id="sync-app-fills-btn" class="sync-btn">ì•± ì²´ê²° ë™ê¸°í™”</button>
      </div>
        <div class="scroll-box">
          <table>
            <thead>
              <tr>
                <th>ì§„ì… ì‹œê°„</th>
                <th>ì²­ì‚° ì‹œê°„</th>
                <th>ì¢…ëª©</th>
                <th>ìƒíƒœ</th>
                <th>ì§„ì… ìˆ˜ëŸ‰</th>
                <th>ì§„ì… í‰ê· ê°€</th>
                <th>ì‹¤í˜„ ìˆ˜ìµë¥ (%)</th>
                <th>ì§„ì… ì½”ë©˜íŠ¸</th>
                <th>ì²­ì‚°/AI ì½”ë©˜íŠ¸</th>
              </tr>
            </thead>
            <tbody>
              {% for rt in round_trades %}
                {% set key = rt.symbol ~ '__' ~ rt.round_id %}

                <!-- â–½ ìš”ì•½ í–‰ (í´ë¦­í•´ì„œ ì—´ê³  ë‹«ê¸°) -->
                <tr class="round-summary-row"
                    data-round-key="{{ key }}"
                    data-date="{{ rt.date }}"
                    style="cursor:pointer;">
                  <td>{{ rt.entry_time }}</td>
                  <td>{{ rt.exit_time }}</td>
                  <td>{{ rt.symbol }}</td>
                  <td>
                    {% if rt.status == "OPEN" %}
                      <span class="badge badge-status-open">OPEN</span>
                    {% else %}
                      <span class="badge badge-status-closed">CLOSED</span>
                    {% endif %}
                  </td>
                  <td>{{ rt.entry_qty }}</td>
                  <td>{{ "%.2f"|format(rt.entry_price) }}</td>
                  <td>{{ "%.2f"|format(rt.realized_profit_pct) }}</td>
                  <td>
                    {% if rt.entry_comment %}{{ rt.entry_comment }}{% else %}-{% endif %}
                  </td>
                  <td>
                    {% if rt.exit_comment %}{{ rt.exit_comment }}{% else %}-{% endif %}
                  </td>
                </tr>

                <!-- â–½ ë””í…Œì¼ í–‰ (ì²˜ìŒì—ëŠ” ìˆ¨ê¹€) -->
                <tr class="round-detail-row"
                    data-round-key="{{ key }}"
                    data-date="{{ rt.date }}"
                    style="display:none;">
                  <td colspan="9">
                    <div style="border-top:1px solid #23263a; margin-top:6px; padding-top:6px;">
                      <table style="width:100%; font-size:11px;">
                        <thead>
                          <tr>
                            <th>ì‹œê°„</th>
                            <th>í–‰ë™</th>
                            <th>ê°€ê²©</th>
                            <th>ìˆ˜ëŸ‰</th>
                            <th>ML ì ìˆ˜</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% if key in round_details %}
                            {% for d in round_details[key] %}
                            <tr>
                              <td>{{ d.time }}</td>
                              <td>{{ d.type }}</td>
                              <td>{{ "%.2f"|format(d.price) }}</td>
                              <td>{{ d.qty }}</td>
                              <td>
                                {% if d.ml_proba is not none %}
                                  {{ "%.3f"|format(d.ml_proba) }}
                                {% else %}
                                  -
                                {% endif %}
                              </td>
                            </tr>
                            {% endfor %}
                          {% else %}
                            <tr><td colspan="5">ì²´ê²° ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                          {% endif %}
                        </tbody>
                      </table>
                    </div>
                  </td>
                </tr>
              {% endfor %}

              {% if round_trades|length == 0 %}
                <tr><td colspan="9">ì•„ì§ í¬ì§€ì…˜ ë‹¨ìœ„ë¡œ ë¬¶ì¸ íŠ¸ë ˆì´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="universe-panel section card">
        <div class="universe-header">
          <div>
            <h2>UNIVERSE OHLCV Coverage</h2>
            <p class="universe-updated">
              Last updated:
              <span>{{ last_universe_backfill or 'â€”' }}</span>
            </p>
          </div>

          <!-- ìš”ì•½ ì¹´ë“œ 3ê°œ ì •ë„ -->
          <div class="universe-summary">
            <div class="universe-summary-item">
              <span class="label">Symbols</span>
              <span class="value">
                {{ num_universe_symbols }}
              </span>
            </div>
            <div class="universe-summary-item">
              <span class="label">Total candles</span>
              <span class="value">
                {{ total_universe_candles }}
              </span>
            </div>
            <div class="universe-summary-item">
              <span class="label">Max days covered</span>
              <span class="value">
                {{ max_days_covered }}
              </span>
            </div>
          </div>
        </div>

        <div class="universe-table-wrapper">
          <table class="universe-table">
            <thead>
              <tr>
                <th>Region</th>
                <th>Symbol</th>
                <th>Interval</th>
                <th class="text-right">Candles</th>
                <th class="text-right">Days</th>
                <th>Start</th>
                <th>End</th>
              </tr>
            </thead>
            <tbody>
              {% for row in universe_cov %}
                {% set days = row.days_covered|int %}
                <tr>
                  <td>{{ row.region }}</td>
                  <td><code>{{ row.symbol }}</code></td>
                  <td>{{ row.interval }}</td>
                  <td class="text-right">{{ row.candles }}</td>
                  <td class="text-right">
                    {% if days >= 20 %}
                      <span class="badge badge-good">{{ days }}</span>
                    {% elif days >= 5 %}
                      <span class="badge badge-mid">{{ days }}</span>
                    {% else %}
                      <span class="badge badge-bad">{{ days }}</span>
                    {% endif %}
                  </td>
                  <td>{{ row.first_dt }}</td>
                  <td>{{ row.last_dt }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="card ml-mornitor-section">
        <div class="ml-chart1">
          <h3>ML í™•ë¥  ë¶„í¬ (íˆìŠ¤í† ê·¸ë¨)</h3>
          <canvas id="mlHistChart"></canvas>
        </div>
        <div class="ml-chart2">
          <h3>ì‹œê°„ëŒ€ë³„ ML í™•ë¥  & ì§„ì… í—ˆìš©</h3>
          <canvas id="mlTimeChart"></canvas>
        </div>
      </div>
      <div class="ml-section">
        <div class="card scroll-box ml-history">
          <h2>ML ëª¨ë¸ ë²„ì „ íˆìŠ¤í† ë¦¬</h2>
          <table class="table table-sm table-striped">
            <thead>
              <tr>
                <th>ID</th>
                <th>ìƒì„±ì¼ì‹œ</th>
                <th>ëª¨ë¸ ê²½ë¡œ</th>
                <th>í•™ìŠµ ìƒ˜í”Œ ìˆ˜</th>
                <th>ê²€ì¦ ì •í™•ë„(%)</th>
              </tr>
            </thead>
            <tbody>
              {% for m in model_versions %}
              <tr>
                <td>{{ m.id }}</td>
                <td>{{ m.created_at }}</td>
                <td>{{ m.path }}</td>
                <td>{{ m.n_samples }}</td>
                <td>{{ "%.2f"|format((m.val_accuracy or 0) * 100) }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="card scroll-box ml-history2">
          <h2>ë°±í…ŒìŠ¤íŠ¸ ê²°ê³¼ (ìµœê·¼ 50ê°œ)</h2>
          <table class="table table-sm table-bordered">
          <thead>
              <tr>
              <th>ID</th>
              <th>ëª¨ë¸(ID / ë²„ì „)</th>
              <th>ê¸°ê°„</th>
              <th>íŠ¸ë ˆì´ë“œ ìˆ˜</th>
              <th>ìŠ¹ë¥ (%)</th>
              <th>í‰ê·  ìˆ˜ìµë¥ (%)</th>
              <th>ëˆ„ì  ìˆ˜ìµë¥ (%)</th>
              <th>ìµœëŒ€ë‚™í­(%)</th>
              <th>ë©”ëª¨</th>
              </tr>
          </thead>
          <tbody>
              {% for b in backtests %}
              <tr>
              <td>{{ b.id }}</td>
              <td>
                  {{ b.model_id }} /
                  {{ b.model_name }} {{ b.model_version }}
              </td>
              <td>{{ b.start_date }} ~ {{ b.end_date }}</td>
              <td>{{ b.trades }}</td>
              <td>{{ "%.2f"|format(b.win_rate or 0) }}</td>
              <td>{{ "%.2f"|format(b.avg_profit or 0) }}</td>
              <td>{{ "%.2f"|format(b.cum_return or 0) }}</td>
              <td>{{ "%.2f"|format(b.max_dd or 0) }}</td>
              <td>{{ b.note }}</td>
              </tr>
              {% endfor %}
          </tbody>
          </table>
        </div>
      </div>
        <!-- ì¢…ëª©ë³„ ì°¨íŠ¸ & ë§¤ë§¤ í‘œì‹œ -->
      <section class="card section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
          <h2 style="margin:0;">ğŸ“Š ì¢…ëª©ë³„ ì°¨íŠ¸ & ë§¤ë§¤ ê¸°ë¡</h2>
          <div>
            <label style="font-size:12px; color:#9da4c2; margin-right:6px;">ì¢…ëª© ì„ íƒ</label>
            <select id="symbol-select" style="background:#020617; color:#e5e7eb; border:1px solid #374151; border-radius:999px; padding:4px 10px; font-size:12px;">
              <option value="">- ì¢…ëª©ì„ ì„ íƒí•˜ì„¸ìš” -</option>
              {% for sym in symbols_with_data %}
                <option value="{{ sym }}">{{ sym }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div style="height:650px;">
          <canvas id="symbolPriceChart"></canvas>
        </div>

        <!-- âœ… ì¢…ëª© ì°¨íŠ¸ ì•ˆë‚´ ë©”ì‹œì§€ -->
        <p id="symbol-chart-status"
          style="font-size:11px; color:#f97316; margin-top:4px;"></p>

        <p style="font-size:11px; color:#6b7280; margin-top:4px;">
          Â· ìº”ë“¤ì€ ë§¤ìˆ˜/ë§¤ë„ ì£¼ë³€ êµ¬ê°„ë§Œ í‘œì‹œë©ë‹ˆë‹¤. / ì´ˆë¡ ì : BUY / ë¹¨ê°„ ì : SELL
        </p>
      </section>
  </div>

  <!-- ì°¨íŠ¸ ìŠ¤í¬ë¦½íŠ¸ -->
  <script>
    const CURRENT_REGION = '{{ region }}';
    // íŒŒì´ì¬ â†’ JS ë°ì´í„° ë³€í™˜ (JSON ë¬¸ìì—´ â†’ ê°ì²´)
    const equityData = JSON.parse('{{ equity_curve | tojson | safe }}');
    const symbolData = JSON.parse('{{ symbols_avg | tojson | safe }}');

    // ëˆ„ì  ìˆ˜ìµë¥  ì°¨íŠ¸
    (function () {
      const ctx = document.getElementById('equityChart');
      if (!ctx || equityData.length === 0) return;

      const labels = equityData.map(d => d.time);
      const values = equityData.map(d => d.value);

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'ëˆ„ì  ìˆ˜ìµë¥ (%)',
            data: values,
            borderWidth: 1.5,
            tension: 0.2,
            pointRadius: 0,
            borderColor: 'rgba(248,250,252,0.9)',        // ë°ì€ í°ìƒ‰ ë¼ì¸
            backgroundColor: 'rgba(248,250,252,0.10)',   // ì‚´ì§ ì±„ìš´ ì˜ì—­
          }]
        },
        options: {
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: { ticks: { maxTicksLimit: 6 } },
            y: { ticks: { callback: v => v + '%' } }
          }
        }
      });
    })();

    // ì¢…ëª©ë³„ í‰ê·  ìˆ˜ìµë¥  ì°¨íŠ¸
    (function () {
      const ctx = document.getElementById('symbolChart');
      if (!ctx || symbolData.length === 0) return;

      const labels = symbolData.map(d => d.symbol);
      const values = symbolData.map(d => d.avg_profit);

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'í‰ê·  ìˆ˜ìµë¥ (%)',
            data: values,
            borderWidth: 1,
            backgroundColor: 'rgba(56,189,248,0.6)',   // í•˜ëŠ˜ìƒ‰ ë§‰ëŒ€
            borderColor: 'rgba(56,189,248,0.9)',
          }]
        },
        options: {
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { ticks: { callback: v => v + '%' } }
          }
        }
      });
    })();

    const mlHistLabels = JSON.parse('{{ ml_hist_labels | tojson | safe }}');
    const mlHistCounts = JSON.parse('{{ ml_hist_counts | tojson | safe }}');
    const mlTimeSeries = JSON.parse('{{ ml_time_series | tojson | safe }}');

    // 1) íˆìŠ¤í† ê·¸ë¨ ì°¨íŠ¸
    if (mlHistLabels.length > 0) {
      const ctxHist = document.getElementById('mlHistChart').getContext('2d');
      new Chart(ctxHist, {
        type: 'bar',
        data: {
          labels: mlHistLabels,
          datasets: [{
            label: 'ì‹ í˜¸ ìˆ˜',
            data: mlHistCounts,
            backgroundColor: 'rgba(129,140,248,0.7)',   // ë³´ë¼ë¹›
            borderColor: 'rgba(129,140,248,1)',
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: { display: false }
          },
          scales: {
            x: { title: { display: true, text: 'ml_proba êµ¬ê°„' } },
            y: { title: { display: true, text: 'count' }, beginAtZero: true }
          }
        }
      });
    }

    // 2) ì‹œê°„ ì‹œê³„ì—´ ì°¨íŠ¸
    if (mlTimeSeries.length > 0) {
      const times = mlTimeSeries.map(d => d.time);
      const probas = mlTimeSeries.map(d => d.proba);
      const allowedPoints = mlTimeSeries
        .map((d, idx) => d.entry_allowed ? { x: idx, y: probas[idx] } : null)
        .filter(d => d !== null);

      const ctxTime = document.getElementById('mlTimeChart').getContext('2d');
      new Chart(ctxTime, {
        type: 'line',
        data: {
          labels: times,
          datasets: [
            {
              label: 'ml_proba',
              data: probas,
              tension: 0.2,
              pointRadius: 2,
              borderColor: 'rgba(52,211,153,0.9)',       // ì´ˆë¡ ë¼ì¸
              backgroundColor: 'rgba(52,211,153,0.15)',
            },
            {
              label: 'entry_allowed=1',
              type: 'scatter',
              data: allowedPoints,
              pointRadius: 5,
              pointStyle: 'circle',
              backgroundColor: 'rgba(239,68,68,0.9)',    // ë¹¨ê°„ ì 
              borderColor: 'rgba(239,68,68,1)',
            }
          ]
        },
        options: {
          responsive: true,
          interaction: { mode: 'nearest', intersect: false },
          scales: {
            x: {
              // âœ… ì¹´í…Œê³ ë¦¬ ì¶• ê·¸ëŒ€ë¡œ ë‘ê³  ë¼ë²¨ë§Œ ê°€ê³µ
              ticks: {
                autoSkip: true,
                maxTicksLimit: 10,
                maxRotation: 15,
                minRotation: 0,
                callback: function(value, index) {
                  const label = times[index]; // "2025-11-27 03:15"
                  // "MM-DD HH:mm"ë§Œ ë‚¨ê¸°ê¸°
                  return label.slice(5, 16);
                }
              },
              title: { display: true, text: 'time' },
            },
            y: {
              title: { display: true, text: 'ml_proba' },
              min: 0,
              max: 1
            }
          }
        }
      });
    }

    (function () {
      const summaryRows = document.querySelectorAll('.round-summary-row');
      if (!summaryRows.length) return;

      summaryRows.forEach(row => {
        row.addEventListener('click', () => {
          const key = row.getAttribute('data-round-key');
          const detailRow = document.querySelector(
            `.round-detail-row[data-round-key="${key}"]`
          );
          if (!detailRow) return;

          const current = detailRow.style.display;
          detailRow.style.display = (!current || current === 'none') ? 'table-row' : 'none';
        });
      });
    })();
    // ì•± ì²´ê²° ìˆ˜ë™ ë™ê¸°í™” ë²„íŠ¼
    document.getElementById("sync-app-fills-btn")?.addEventListener("click", () => {
  
      if (!confirm("ì•± ì²´ê²°ë‚´ì—­ì„ ë™ê¸°í™”í• ê¹Œìš”?")) return;

      fetch("/sync_app_fills", { method: "POST" })
        .then(res => res.json())
        .then(data => {
          if (data.status === "ok") {
            alert("ë™ê¸°í™” ì™„ë£Œ!\n" + data.message);
            location.reload();
          } else {
            alert("ë™ê¸°í™” ì‹¤íŒ¨:\n" + data.message);
          }
        })
        .catch(err => alert("ì—ëŸ¬: " + err));
    });
        // ë‚ ì§œ ë“œë¡­ë‹¤ìš´ìœ¼ë¡œ íŠ¸ë ˆì´ë“œ/ìš”ì•½ í•„í„°
    (function () {
      const dailySummaries = JSON.parse('{{ daily_summaries | tojson | safe }}');
      const select = document.getElementById('trade-date-select');
      if (!select || !dailySummaries.length) return;

      const elDate = document.getElementById('trade-date-label');
      const elCnt  = document.getElementById('trade-date-total');
      const elWin  = document.getElementById('trade-date-winrate');
      const elAvg  = document.getElementById('trade-date-avg');
      const elCum  = document.getElementById('trade-date-cum');

      function updateSummary(dateValue) {
        if (dateValue === 'ALL') {
          elDate.textContent = 'ì „ì²´ ê¸°ê°„';
          elCnt.textContent  = '{{ summary.total_trades }}';
          elWin.textContent  = '{{ "%.2f"|format(summary.win_rate) }}%';
          elAvg.textContent  = '{{ "%.2f"|format(summary.avg_profit) }}%';
          elCum.textContent  = '{{ "%.2f"|format(summary.cum_return_pct) }}%';
          return;
        }
        const found = dailySummaries.find(d => d.date === dateValue);
        if (!found) return;
        elDate.textContent = found.date;
        elCnt.textContent  = found.total_trades;
        elWin.textContent  = found.win_rate.toFixed(2) + '%';
        elAvg.textContent  = found.avg_profit.toFixed(2) + '%';
        elCum.textContent  = found.cum_return_pct.toFixed(2) + '%';
      }

      function applyFilter(dateValue) {
        const summaryRows = document.querySelectorAll('.round-summary-row');
        const detailRows  = document.querySelectorAll('.round-detail-row');

        summaryRows.forEach(row => {
          const d = row.getAttribute('data-date');
          const show = (dateValue === 'ALL' || d === dateValue);
          row.style.display = show ? 'table-row' : 'none';
        });

        // í•„í„° ë°”ê¾¸ë©´ ë””í…Œì¼ í–‰ì€ ê¸°ë³¸ì ìœ¼ë¡œ ì ‘ì–´ì„œ ì‹œì‘
        detailRows.forEach(row => {
          const d = row.getAttribute('data-date');
          const show = (dateValue === 'ALL' || d === dateValue);
          row.style.display = 'none';
        });
      }

      select.addEventListener('change', () => {
        const v = select.value;
        updateSummary(v);
        applyFilter(v);
      });

      // ì´ˆê¸°ê°’: selectì— ì§€ì •ëœ ê°’ ê¸°ì¤€ìœ¼ë¡œ í•œ ë²ˆ ì ìš©
      updateSummary(select.value);
      applyFilter(select.value);
    })();

    (function () {
      const selectEl = document.getElementById("symbol-select");
      const canvasEl = document.getElementById("symbolPriceChart");
      if (!selectEl || !canvasEl) return;

      let symbolChart = null;   // í˜„ì¬ ì¢…ëª© ì°¨íŠ¸ í•¸ë“¤

      async function loadSymbolData(symbol) {
        const res = await fetch(`/symbol_data?symbol=${encodeURIComponent(symbol)}&region=${encodeURIComponent(CURRENT_REGION)}`);
        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }
        return await res.json();   // { ohlcv: [...], trades: [...] } í˜•íƒœë¼ê³  ê°€ì •
      }

    function renderSymbolChart(data, symbol) {
      const ctx = canvasEl.getContext("2d");
      const statusEl = document.getElementById("symbol-chart-status");

      // ì•ˆë‚´ ë¬¸êµ¬ ì´ˆê¸°í™”
      if (statusEl) statusEl.textContent = "";

      // ê¸°ì¡´ ì°¨íŠ¸ ìˆìœ¼ë©´ ì œê±°
      if (symbolChart) {
        symbolChart.destroy();
        symbolChart = null;
      }

      let priceSeries = data.candles || [];
      const tradesRaw = data.trades || [];

      // 0) ë§¤ìˆ˜Â·ë§¤ë„ ì•„ì˜ˆ ì—†ìœ¼ë©´
      if (!tradesRaw.length) {
        if (statusEl) {
          statusEl.textContent = "ì´ ì¢…ëª©ì—ëŠ” ì•„ì§ ë§¤ìˆ˜/ë§¤ë„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.";
        }
        ctx.clearRect(0, 0, canvasEl.width, canvasEl.height);
        return;
      }

      // 1) ìº”ë“¤ ë°ì´í„° ì—†ìœ¼ë©´
      if (!priceSeries.length) {
        if (statusEl) {
          statusEl.textContent = "ìº”ë“¤ ë°ì´í„°ê°€ ì—†ì–´ ì°¨íŠ¸ë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        }
        return;
      }

      // âœ… 2) íŠ¸ë ˆì´ë“œì— ms íƒ€ì„ìŠ¤íƒ¬í”„ ë¶™ì´ê¸°
      const tradesAll = tradesRaw.map(t => {
        const ms = new Date(t.time).getTime();
        return { ...t, _ms: ms };
      });

      // í˜¹ì‹œë¼ë„ ë°©ì–´
      if (!tradesAll.length) {
        if (statusEl) statusEl.textContent = "ì´ ì¢…ëª©ì—ëŠ” ì•„ì§ ë§¤ìˆ˜/ë§¤ë„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.";
        ctx.clearRect(0, 0, canvasEl.width, canvasEl.height);
        return;
      }

      // âœ… 3) ê°€ì¥ ìµœê·¼ íŠ¸ë ˆì´ë“œ ê¸°ì¤€ìœ¼ë¡œë§Œ ë³´ê¸°
      const latestTrade = tradesAll.reduce((a, b) => (a._ms > b._ms ? a : b));
      const latestMs = latestTrade._ms;
      const DAY = 24 * 60 * 60 * 1000; // 1ì¼

      // ğŸ”¹ (1) ìº”ë“¤: ìµœê·¼ íŠ¸ë ˆì´ë“œ ê¸°ì¤€ -1ì¼ ~ +1ì¼ë§Œ ë‚¨ê¸°ê¸°
      const allCandles = priceSeries;  // ì›ë³¸ ë³´ê´€
      priceSeries = allCandles.filter(row => {
        const ms = new Date(row.time).getTime();
        return ms >= latestMs - DAY && ms <= latestMs + DAY;
      });

      // ìº”ë“¤ì´ 0ê°œë©´, ì¼ë‹¨ ì „ì²´ë¡œ fallback
      if (!priceSeries.length) {
        console.warn(`[${symbol}] ìµœê·¼ íŠ¸ë ˆì´ë“œ ì£¼ë³€ì— ìº”ë“¤ì´ ì—†ì–´ ì „ì²´ êµ¬ê°„ìœ¼ë¡œ fallback`);
        priceSeries = allCandles;
      }

      // ğŸ”¹ (2) íŠ¸ë ˆì´ë“œ: ë§ˆì°¬ê°€ì§€ë¡œ ìµœê·¼ íŠ¸ë ˆì´ë“œ Â±1ì¼ë§Œ ë‚¨ê¸°ê¸°
      const trades = tradesAll.filter(t => t._ms >= latestMs - DAY && t._ms <= latestMs + DAY);

      // ì´ì œ ì´ ì´í›„ ë¡œì§(ìµœê·¼ ì¸ë±ìŠ¤ ì°¾ê¸° ë“±)ì€ ê·¸ëŒ€ë¡œ ì‚¬ìš©
      const candleTimes = priceSeries.map(r => new Date(r.time).getTime());


      // 3) ê° íŠ¸ë ˆì´ë“œê°€ ê°€ì¥ ê°€ê¹Œìš´ ìº”ë“¤ ì¸ë±ìŠ¤ë¥¼ ì°¾ê¸°
      function findNearestIndex(targetMs) {
        let bestIdx = 0;
        let bestDiff = Infinity;
        for (let i = 0; i < candleTimes.length; i++) {
          const d = Math.abs(candleTimes[i] - targetMs);
          if (d < bestDiff) {
            bestDiff = d;
            bestIdx = i;
          }
        }
        return bestIdx;
      }

      let minIdx = candleTimes.length - 1;
      let maxIdx = 0;
      trades.forEach(t => {
        const idx = findNearestIndex(t._ms);
        if (idx < minIdx) minIdx = idx;
        if (idx > maxIdx) maxIdx = idx;
      });

      // 4) ì•ë’¤ë¡œ 40ë´‰ì”© í™•ì¥
      const PADDING = 40;
      const startIdx = Math.max(0, minIdx - PADDING);
      const endIdx   = Math.min(priceSeries.length - 1, maxIdx + PADDING);

      const windowCandles = priceSeries.slice(startIdx, endIdx + 1);

      // 5) ì´ êµ¬ê°„ì˜ ì‹œê°„ ë²”ìœ„
      const windowStartMs = candleTimes[startIdx];
      const windowEndMs   = candleTimes[endIdx];

      // 6) ì´ êµ¬ê°„ ì•ˆì— ìˆëŠ” íŠ¸ë ˆì´ë“œë§Œ ì‚¬ìš©
      const tradesInWindow = trades.filter(t => t._ms >= windowStartMs && t._ms <= windowEndMs);

      // 7) ìº”ë“¤/í¬ì¸íŠ¸ ë°ì´í„°ë¥¼ ì°¨íŠ¸ìš©ìœ¼ë¡œ ë³€í™˜ (ms ìˆ«ì ì‚¬ìš©)
      const candleData = windowCandles.map(row => ({
        x: new Date(row.time).getTime(),   // ms
        o: Number(row.open),
        h: Number(row.high),
        l: Number(row.low),
        c: Number(row.close),
      }));

        // âœ… Yì¶• ë²”ìœ„ ê³„ì‚° (ìµœì €~ìµœê³  + 10% íŒ¨ë”©)
      const lows  = candleData.map(c => c.l);
      const highs = candleData.map(c => c.h);
      let yMin = Math.min(...lows);
      let yMax = Math.max(...highs);

      const range = yMax - yMin || yMin * 0.01;   // 0 ë‚˜ëˆ„ê¸° ë°©ì§€
      const pad   = range * 0.1;                  // 10% ì—¬ìœ 

      yMin -= pad;
      yMax += pad;

      // BUY / SELL ë¶„ë¥˜ â€“ type/side/action ì¤‘ ë­ê°€ ì™€ë„ ì›¬ë§Œí•˜ë©´ ì¡íˆê²Œ
      const buyPoints = [];
      const sellPoints = [];

      tradesInWindow.forEach(t => {
        // side / action / type / reason / comment ë“±ì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ
        const labelSrc = (
          t.side ||
          t.action ||
          t.type ||
          t.reason ||
          t.exit_reason ||
          t.comment ||
          ""
        ).toString().toUpperCase();

        // ë¬¸ìì—´ì— ë”°ë¼ ì—”íŠ¸ë¦¬/ì²­ì‚° ì¶”ì •
        const hasBuyWord = (
          labelSrc.includes("BUY") ||
          labelSrc.includes("ENTRY")      // ENTRY, RE_ENTRY ë“±
        );

        const hasSellWord = (
          labelSrc.includes("SELL") ||
          labelSrc.includes("PROFIT") ||  // PROFIT_5%, PROFIT_3%
          labelSrc.includes("CUT") ||     // cut_loss
          labelSrc.includes("LOSS") ||
          labelSrc.includes("TP") ||      // take profit
          labelSrc.includes("STOP") ||    // stop loss
          labelSrc.includes("ìµì ˆ") ||
          labelSrc.includes("ì†ì ˆ")
        );

        let isBuy = false;
        let isSell = false;

        // ìš°ì„ ìˆœìœ„: ì²­ì‚° ë‹¨ì–´ê°€ ìˆìœ¼ë©´ SELL, ì—”íŠ¸ë¦¬ ë‹¨ì–´ê°€ ìˆìœ¼ë©´ BUY
        if (hasSellWord && !hasBuyWord) {
          isSell = true;
        } else if (hasBuyWord && !hasSellWord) {
          isBuy = true;
        } else {
          // ë‘˜ ë‹¤ ì—†ê±°ë‚˜ ë‘˜ ë‹¤ ìˆëŠ” ì• ëŠ” í‘œì‹œ ì•ˆ í•¨
          return;
        }

        const point = {
          x: t._ms,                // ìœ„ì—ì„œ ë§Œë“  ms ì‹œê°„
          y: Number(t.price),
        };

        if (isBuy)  buyPoints.push(point);
        if (isSell) sellPoints.push(point);
      });

      // 8) ì°¨íŠ¸ ìƒì„±
      symbolChart = new Chart(ctx, {
        type: "candlestick",
        data: {
          datasets: [
            {
              label: symbol + " 5m",
              data: candleData,
              color: {
                up: "#22c55e",
                down: "#ef4444",
                unchanged: "#e5e7eb",
              },
              borderColor: {
                up: "#22c55e",
                down: "#ef4444",
                unchanged: "#e5e7eb",
              },
              borderWidth: 1,
            },
            {
              label: "BUY",
              type: "scatter",
              data: buyPoints,
              pointRadius: 4,
              backgroundColor: "#22c55e",
              borderColor: "#22c55e",
            },
            {
              label: "SELL",
              type: "scatter",
              data: sellPoints,
              pointRadius: 4,
              backgroundColor: "#f97316",
              borderColor: "#f97316",
            },
          ],
        },
        options: {
          parsing: false,
          plugins: {
            legend: {
              labels: { color: "#e5e7eb" },
            },
          },
          scales: {
            x: {
              type: "time",
              time: {
                unit: "hour",
                tooltipFormat: "MM-dd HH:mm",
              },
              ticks: { color: "#9ca3af" },
              grid: { color: "rgba(148, 163, 184, 0.1)" },
            },
            y: {
              position: "right",
              min: yMin,
              max: yMax,
              ticks: { color: "#9ca3af" },
              grid: { color: "rgba(148, 163, 184, 0.1)" },
            },
          },
        },
      });

      // ë””ë²„ê¹…: ì½˜ì†”ì—ì„œ í•œ ë²ˆ ì²´í¬í•´ë³´ê³  ì‹¶ìœ¼ë©´
      console.log(
        `[${symbol}] candles: ${windowCandles.length}, trades: ${tradesInWindow.length}, BUY: ${buyPoints.length}, SELL: ${sellPoints.length}`
      );
    }

      // ë“œë¡­ë‹¤ìš´ ë³€ê²½ ì‹œ
      selectEl.addEventListener("change", async () => {
        const sym = selectEl.value;
        if (!sym) {
          if (symbolChart) {
            symbolChart.destroy();
            symbolChart = null;
          }
          return;
        }

        try {
          const data = await loadSymbolData(sym);
          renderSymbolChart(data, sym);
        } catch (err) {
          console.error(err);
          alert("ì‹¬ë³¼ ì°¨íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      });

      // ì´ˆê¸° ë Œë”: ì²« ë²ˆì§¸ ì¢…ëª© ìë™ ë¡œë“œ
      if (selectEl.value) {
        loadSymbolData(selectEl.value)
          .then(data => renderSymbolChart(data, selectEl.value))
          .catch(err => console.error(err));
      }
    })();
    
    // AI ë¦¬í¬íŠ¸ ì „ì²´ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadAiReportFull() {
      try {
        const res = await fetch('/api/ai-report/full');
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();

        // ìƒë‹¨ ë‚ ì§œ/ìƒì„± ì‹œê°
        const dateLabel = data.date
          ? `${data.date} ê¸°ì¤€ AI ë¦¬í¬íŠ¸`
          : 'AI ë¦¬í¬íŠ¸ (ë°ì´í„° ì—†ìŒ)';
        document.getElementById('ai-report-date').textContent = dateLabel;

        if (data.created_at) {
          document.getElementById('ai-report-created-at').textContent =
            `ìƒì„± ì‹œê°: ${data.created_at}`;
        } else {
          document.getElementById('ai-report-created-at').textContent = '';
        }

        // 1) ì¼ì¼ ë¦¬í¬íŠ¸
        document.getElementById('ai-daily-report').textContent =
          data.daily_report && data.daily_report.trim()
            ? data.daily_report
            : 'ì•„ì§ ìƒì„±ëœ ì¼ì¼ íŠ¸ë ˆì´ë“œ ë¦¬í¬íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.';

        // 2) ì „ëµ ì•„ì´ë””ì–´
        document.getElementById('ai-strategy-ideas').textContent =
          data.strategy_ideas && data.strategy_ideas.trim()
            ? data.strategy_ideas
            : 'ì•„ì§ ìƒì„±ëœ ì „ëµ ì•„ì´ë””ì–´ ë¸Œë ˆì¸ìŠ¤í† ë° ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.';

        // 3) ëª¨ë¸ ì¡°ì–¸
        const modelAdviceDate = data.model_advice_date
          ? `(${data.model_advice_date} ê¸°ì¤€)`
          : '';
        document.getElementById('ai-model-advice-date').textContent = modelAdviceDate;

        document.getElementById('ai-model-advice').textContent =
          data.model_advice && data.model_advice.trim()
            ? data.model_advice
            : 'ì•„ì§ ì €ì¥ëœ ëª¨ë¸ ì—…ë°ì´íŠ¸/íŠœë‹ ì¡°ì–¸ì´ ì—†ìŠµë‹ˆë‹¤.\n\n' +
              'ğŸ‘‰ daily_ml_cycle.pyë¥¼ í•œ ë²ˆ ì‹¤í–‰í•˜ë©´ reports/ ì•„ë˜ì—\n' +
              '   *_model_advice.txt íŒŒì¼ì´ ìƒì„±ë˜ê³  ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤.';
      } catch (err) {
        console.error('AI ë¦¬í¬íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', err);
        document.getElementById('ai-daily-report').textContent =
          'AI ë¦¬í¬íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        document.getElementById('ai-strategy-ideas').textContent = '';
        document.getElementById('ai-model-advice').textContent =
          'ëª¨ë¸ ì¡°ì–¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      }
    }

    // íƒ­ í´ë¦­ ì‹œ ìµœì´ˆ 1ë²ˆë§Œ ë¡œë“œ
    let aiReportLoaded = false;
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('tab-btn-ai-report');
      if (!btn) return;

      btn.addEventListener('click', () => {
        // íƒ­ show/hideëŠ” ë„ˆ ê¸°ì¡´ ë¡œì§ì— ë§ì¶°ì„œ ì²˜ë¦¬
        document.getElementById('tab-ai-report').style.display = 'block';

        if (!aiReportLoaded) {
          loadAiReportFull();
          aiReportLoaded = true;
        }
      });
    });


  </script>
</body>
</html>
