{% extends "base.html" %}

{% block content %}
<div class="layout">
  <h1>ğŸ“ˆ ì¢…ëª©ë³„ ì°¨íŠ¸ & ë§¤ë§¤ ê¸°ë¡</h1>

  <div style="display: flex; flex-direction: row; justify-content: space-between; align-items: baseline; padding: 0 10px; margin-bottom: 10px;">
    <div class="card-header" style="margin-bottom: 0;">ğŸ“Š ì¢…ëª©ë³„ ì°¨íŠ¸ & ë§¤ë§¤ ê¸°ë¡</div>
    <div>
      <label style="font-size:12px; color:#9da4c2; margin-right:6px;">ì¢…ëª© ì„ íƒ</label>
      <select id="symbol-select"
              style="background:#020617; color:#e5e7eb; border:1px solid #374151; border-radius:999px; padding:4px 10px; font-size:12px;">
        <option value="">- ì¢…ëª©ì„ ì„ íƒí•˜ì„¸ìš” -</option>
        {% for sym in symbols_with_data %}
          <option value="{{ sym }}">{{ sym }}</option>
        {% endfor %}
      </select>
    </div>
  </div>
    
  <section class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">

    </div>

    <div style="height:650px;">
      <canvas id="symbolPriceChart"></canvas>
    </div>

    <p id="symbol-chart-status"
       style="font-size:11px; color:#f97316; margin-top:4px;"></p>

    <p style="font-size:11px; color:#6b7280; margin-top:4px;">
      Â· ìº”ë“¤ì€ ë§¤ìˆ˜/ë§¤ë„ ì£¼ë³€ êµ¬ê°„ë§Œ í‘œì‹œë©ë‹ˆë‹¤. / ì´ˆë¡ ì : BUY / ë¹¨ê°„ ì : SELL
    </p>
  </section>
</div>
{% endblock %}

{% block scripts %}
<script>
  const CURRENT_REGION = '{{ region }}';

  (function () {
    const selectEl = document.getElementById("symbol-select");
    const canvasEl = document.getElementById("symbolPriceChart");
    if (!selectEl || !canvasEl) return;

    let symbolChart = null;

    async function loadSymbolData(symbol) {
      const res = await fetch(`/symbol_data?symbol=${encodeURIComponent(symbol)}&region=${encodeURIComponent(CURRENT_REGION)}`);
      if (!res.ok) {
        throw new Error("HTTP " + res.status);
      }
      return await res.json();
    }

  function renderSymbolChart(data, symbol) {
    const ctx = canvasEl.getContext("2d");
    const statusEl = document.getElementById("symbol-chart-status");

    if (statusEl) statusEl.textContent = "";

    if (symbolChart) {
      symbolChart.destroy();
      symbolChart = null;
    }

    let priceSeries = data.candles || [];
    const tradesRaw = data.trades || [];

    // 1) ë°ì´í„° ì¡´ì¬ ì²´í¬
    if (!priceSeries.length) {
      if (statusEl) statusEl.textContent = "ìº”ë“¤ ë°ì´í„°ê°€ ì—†ì–´ ì°¨íŠ¸ë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
      ctx.clearRect(0, 0, canvasEl.width, canvasEl.height);
      return;
    }

    if (!tradesRaw.length) {
      if (statusEl) statusEl.textContent = "ì´ ì¢…ëª©ì—ëŠ” ì•„ì§ ë§¤ìˆ˜/ë§¤ë„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.";
      // ê·¸ë˜ë„ ìº”ë“¤ë§Œ ë³´ê³  ì‹¶ìœ¼ë©´ ì•„ë˜ ë‘ ì¤„ì„ ì§€ìš°ê³  ì°¨íŠ¸ ê·¸ë¦¬ê²Œ í•´ë„ ë¨
      // ctx.clearRect(0, 0, canvasEl.width, canvasEl.height);
      // return;
    }

    // 2) ì „ì²´ ìº”ë“¤ / ì „ì²´ íŠ¸ë ˆì´ë“œ ì‚¬ìš© (ì˜ë¼ë‚´ì§€ ì•ŠìŒ)
    const allCandles = priceSeries;
    const tradesAll = tradesRaw.map(t => {
      const ms = new Date(t.time).getTime();
      return { ...t, _ms: ms };
    });

    // 3) ì°¨íŠ¸ì— ì“¸ ìº”ë“¤ ë°ì´í„° (ì „ì²´)
    const candleData = allCandles.map(row => ({
      x: new Date(row.time).getTime(),
      o: Number(row.open),
      h: Number(row.high),
      l: Number(row.low),
      c: Number(row.close),
    }));

    // 4) Yì¶• ë²”ìœ„ ê³„ì‚° (ì „ì²´ êµ¬ê°„ ê¸°ì¤€)
    const lows  = candleData.map(c => c.l);
    const highs = candleData.map(c => c.h);
    let yMin = Math.min(...lows);
    let yMax = Math.max(...highs);

    const range = yMax - yMin || yMin * 0.01;
    const pad   = range * 0.1;

    yMin -= pad;
    yMax += pad;

    // 5) BUY / SELL í¬ì¸íŠ¸ ë¶„ë¥˜ (ì „ì²´ ë§¤ë§¤ ê¸°ì¤€)
    const buyPoints = [];
    const sellPoints = [];

    tradesAll.forEach(t => {
      const labelSrc = (
        t.side ||
        t.action ||
        t.type ||
        t.reason ||
        t.exit_reason ||
        t.comment ||
        ""
      ).toString().toUpperCase();

      const hasBuyWord = (
        labelSrc.includes("BUY") ||
        labelSrc.includes("ENTRY")
      );

      const hasSellWord = (
        labelSrc.includes("SELL") ||
        labelSrc.includes("PROFIT") ||
        labelSrc.includes("CUT") ||
        labelSrc.includes("LOSS") ||
        labelSrc.includes("TP") ||
        labelSrc.includes("STOP") ||
        labelSrc.includes("ìµì ˆ") ||
        labelSrc.includes("ì†ì ˆ")
      );

      let isBuy = false;
      let isSell = false;

      if (hasSellWord && !hasBuyWord) {
        isSell = true;
      } else if (hasBuyWord && !hasSellWord) {
        isBuy = true;
      } else {
        return; // ë‘˜ ë‹¤ ìˆê±°ë‚˜ ë‘˜ ë‹¤ ì—†ìœ¼ë©´ ë¬´ì‹œ
      }

      const point = {
        x: t._ms,
        y: Number(t.price),
      };

      if (isBuy)  buyPoints.push(point);
      if (isSell) sellPoints.push(point);
    });

    // 6) ì°¨íŠ¸ ê·¸ë¦¬ê¸° (ì´ì œ ì „ì²´ ê¸°ê°„ ê¸°ì¤€)
    symbolChart = new Chart(ctx, {
      type: "candlestick",
      data: {
        datasets: [
          {
            label: symbol + " 5m",
            data: candleData,
            color: {
              up: "#22c55e",
              down: "#ef4444",
              unchanged: "#e5e7eb",
            },
            borderColor: {
              up: "#22c55e",
              down: "#ef4444",
              unchanged: "#e5e7eb",
            },
            borderWidth: 1,
          },
          {
            label: "BUY",
            type: "scatter",
            data: buyPoints,
            pointRadius: 4,
            backgroundColor: "#22c55e",
            borderColor: "#22c55e",
          },
          {
            label: "SELL",
            type: "scatter",
            data: sellPoints,
            pointRadius: 4,
            backgroundColor: "#f97316",
            borderColor: "#f97316",
          },
        ],
      },
      options: {
        parsing: false,
        plugins: {
          legend: {
            labels: { color: "#e5e7eb" },
          },
        },
        scales: {
          x: {
            type: "time",
            time: {
              unit: "hour",
              tooltipFormat: "MM-dd HH:mm",
            },
            ticks: { color: "#9ca3af" },
            grid: { color: "rgba(148, 163, 184, 0.1)" },
          },
          y: {
            position: "right",
            min: yMin,
            max: yMax,
            ticks: { color: "#9ca3af" },
            grid: { color: "rgba(148, 163, 184, 0.1)" },
          },
        },
      },
    });

    console.log(
      `[${symbol}] candles: ${candleData.length}, trades: ${tradesAll.length}, BUY: ${buyPoints.length}, SELL: ${sellPoints.length}`
    );
  }

    selectEl.addEventListener("change", async () => {
      const sym = selectEl.value;
      if (!sym) {
        if (symbolChart) {
          symbolChart.destroy();
          symbolChart = null;
        }
        return;
      }

      try {
        const data = await loadSymbolData(sym);
        renderSymbolChart(data, sym);
      } catch (err) {
        console.error(err);
        alert("ì‹¬ë³¼ ì°¨íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    });

    if (selectEl.value) {
      loadSymbolData(selectEl.value)
        .then(data => renderSymbolChart(data, selectEl.value))
        .catch(err => console.error(err));
    }
  })();
</script>
{% endblock %}
