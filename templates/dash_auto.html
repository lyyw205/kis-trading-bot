{% extends "base.html" %}

{% block content %}
<div class="layout">
  <h1>âš™ï¸ ìë™ë§¤ë§¤</h1>
  <div style="display: flex; flex-direction: row; justify-content: space-between; align-items: baseline;">
    <div class="card-header">ğŸ“‘ íŠ¸ë ˆì´ë“œ</div>
    <div class="trade-date-summary">
      <span id="trade-date-label">-</span> Â·
      íŠ¸ë ˆì´ë“œ <strong id="trade-date-total">0</strong>ê±´ Â·
      ìŠ¹ë¥  <strong id="trade-date-winrate">0%</strong> Â·
      í‰ê·  <strong id="trade-date-avg">0%</strong> Â·
      ëˆ„ì  <strong id="trade-date-cum">0%</strong>
    </div>
  </div>
  <!-- 1) íŠ¸ë ˆì´ë“œ ì„¹ì…˜ -->
  
  <div class="card" style="max-height: 320px;">
    <div style="display:flex; justify-content:end; align-items:center; margin-bottom:8px; gap:12px; flex-wrap:wrap;">
      <button id="sync-app-fills-btn" class="sync-btn">ì•± ì²´ê²° ë™ê¸°í™”</button>
      <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
        {% if daily_summaries and daily_summaries|length > 0 %}
        <select id="trade-date-select" class="trade-date-select">
          <option value="ALL">ì „ì²´ ê¸°ê°„</option>
          {% for d in daily_summaries %}
          <option value="{{ d.date }}" {% if loop.first %}selected{% endif %}>
            {{ d.date }} ({{ d.total_trades }}ê±´)
          </option>
          {% endfor %}
        </select>
        {% endif %}
      </div>
    </div>

    <div class="scroll-box">
      <table>
        <thead>
          <tr>
            <th>ì§„ì… ì‹œê°„</th>
            <th>ì²­ì‚° ì‹œê°„</th>
            <th>ì¢…ëª©</th>
            <th>ìƒíƒœ</th>
            <th>ì§„ì… ìˆ˜ëŸ‰</th>
            <th>ì§„ì… í‰ê· ê°€</th>
            <th>ì‹¤í˜„ ìˆ˜ìµë¥ (%)</th>
          </tr>
        </thead>
        <tbody>
          {% for rt in round_trades %}
            {% set key = rt.symbol ~ '__' ~ rt.round_id %}

            <!-- ìš”ì•½ í–‰ -->
            <tr class="round-summary-row"
                data-round-key="{{ key }}"
                data-date="{{ rt.date }}"
                style="cursor:pointer;">
              <td>{{ rt.entry_time }}</td>
              <td>{{ rt.exit_time }}</td>
              <td>{{ rt.symbol }}</td>
              <td>
                {% if rt.status == "OPEN" %}
                  <span class="badge badge-status-open">OPEN</span>
                {% else %}
                  <span class="badge badge-status-closed">CLOSED</span>
                {% endif %}
              </td>
              <td>{{ rt.entry_qty }}</td>
              <td>{{ "%.2f"|format(rt.entry_price) }}</td>
              <td>{{ "%.2f"|format(rt.realized_profit_pct) }}</td>
            </tr>

            <!-- ë””í…Œì¼ í–‰ -->
            <tr class="round-detail-row"
                data-round-key="{{ key }}"
                data-date="{{ rt.date }}"
                style="display:none;">
              <td colspan="7">
                <div style="border-top:1px solid #23263a; margin-top:6px; padding-top:6px;">
                  <table style="width:100%; font-size:11px;">
                    <thead>
                      <tr>
                        <th style="width: 12%;">ì‹œê°„</th>
                        <th style="width: 7%;">í–‰ë™</th>
                        <th style="width: 7%;">ê°€ê²©</th>
                        <th style="width: 7%;">ìˆ˜ëŸ‰</th>
                        <th style="width: 7%;">ML ì ìˆ˜</th>
                        <th style="width: 60%;">AI ì½”ë©˜íŠ¸</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% if key in round_details %}
                        {% for d in round_details[key] %}
                        <tr>
                          <td>{{ d.time }}</td>
                          <td>{{ d.type }}</td>
                          <td>{{ "%.2f"|format(d.price) }}</td>
                          <td>{{ d.qty }}</td>
                          <td>
                            {% if d.ml_proba is not none %}
                              {{ "%.3f"|format(d.ml_proba) }}
                            {% else %}
                              -
                            {% endif %}
                          </td>
                          <td style="text-align: left; color: #a0aec0; padding: 10px 0;">
                            {% if d.type == 'BUY' %}
                                {% if rt.entry_comment %}
                                    {{ rt.entry_comment }}
                                {% endif %}
                            {% else %}
                                {% if rt.exit_comment %}
                                    {{ rt.exit_comment }}
                                {% endif %}
                            {% endif %}
                          </td>
                        </tr>
                        {% endfor %}
                      {% else %}
                        <tr><td colspan="5">ì²´ê²° ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                      {% endif %}
                    </tbody>
                  </table>
                </div>
              </td>
            </tr>
          {% endfor %}

          {% if round_trades|length == 0 %}
            <tr><td colspan="9">ì•„ì§ í¬ì§€ì…˜ ë‹¨ìœ„ë¡œ ë¬¶ì¸ íŠ¸ë ˆì´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- 2) ì¢…ëª©ë³„ ì°¨íŠ¸ & ë§¤ë§¤ ê¸°ë¡ -->
  <div style="margin-top: 24px;">
    <div style="display: flex; flex-direction: row; justify-content: space-between; align-items: baseline; padding: 0 10px; margin-bottom: 10px;">
      <div class="card-header" style="margin-bottom: 0;">ğŸ“ˆ ì¢…ëª©ë³„ ì°¨íŠ¸ & ë§¤ë§¤ ê¸°ë¡</div>
      <div>
        <label style="font-size:12px; color:#9da4c2; margin-right:6px;">ì¢…ëª© ì„ íƒ</label>
        <select id="symbol-select"
                style="background:#020617; color:#e5e7eb; border:1px solid #374151; border-radius:999px; padding:4px 10px; font-size:12px;">
          <option value="">- ì¢…ëª©ì„ ì„ íƒí•˜ì„¸ìš” -</option>
          {% for sym in symbols_with_data %}
            <option value="{{ sym }}">{{ sym }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
      
    <section class="card">
      <div style="height:650px;">
        <canvas id="symbolPriceChart"></canvas>
      </div>

      <p id="symbol-chart-status"
         style="font-size:11px; color:#f97316; margin-top:4px;"></p>

      <p style="font-size:11px; color:#6b7280; margin-top:4px;">
        Â· ìº”ë“¤ì€ ì „ì²´ êµ¬ê°„(ìµœëŒ€ 500ê°œ ìº”ë“¤)ì— ëŒ€í•´ í‘œì‹œë©ë‹ˆë‹¤. / ì´ˆë¡ ì : BUY / ë¹¨ê°„ ì : SELL
      </p>
    </section>
  </div>

  <!-- 3) AI ì˜ì‚¬ê²°ì • ë¡œê·¸ -->
  <div>
    <div class="card-header">ğŸ¤– AI ì˜ì‚¬ê²°ì • ë¡œê·¸ (ìµœê·¼ 200ê°œ ì‹ í˜¸)</div>
    <div class="card">
      <div class="scroll-box">
        <table>
          <thead>
            <tr>
              <th>ì‹œê°„</th>
              <th>ì‹œì¥</th>
              <th>ì¢…ëª©</th>
              <th>ê°€ê²©</th>
              <th>ë£°ì‹ í˜¸</th>
              <th>ML ì ìˆ˜</th>
              <th>ì§„ì…í—ˆìš©</th>
              <th>ë³´ìœ ì¤‘</th>
              <th>ë¹„ê³ </th>
            </tr>
          </thead>
          <tbody>
            {% for s in signals %}
            <tr>
              <td>{{ s.time }}</td>
              <td>{{ s.region }}</td>
              <td>{{ s.symbol }}</td>
              <td>{{ "%.2f"|format(s.price) }}</td>
              <td>{% if s.entry_signal %}âœ…{% else %}âŒ{% endif %}</td>
              <td>
                {% if s.ml_proba is not none %}
                  {{ "%.3f"|format(s.ml_proba) }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>
                {% if s.entry_allowed is none %}
                  -
                {% elif s.entry_allowed %}
                  âœ…
                {% else %}
                  âŒ
                {% endif %}
              </td>
              <td>{% if s.has_stock %}ë³´ìœ {% else %}-{% endif %}</td>
              <td>{{ s.note }}</td>
            </tr>
            {% endfor %}
            {% if signals|length == 0 %}
            <tr><td colspan="9">ì•„ì§ ê¸°ë¡ëœ ì‹ í˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 4) ì‹¤í–‰ ë¡œê·¸ -->
  <div style="display: flex; flex-direction: row; gap: 20px;">
    <div>
        <div class="card-header">ğŸ“ ì‹¤í–‰ ë¡œê·¸ (ìµœê·¼ 200ê°œ)</div>
        <div class="card scroll-box">
          <table>
            <thead>
              <tr>
                <th>ì‹œê°„</th>
                <th>ë©”ì‹œì§€</th>
              </tr>
            </thead>
            <tbody>
              {% for log in logs %}
              <tr>
                <td>{{ log.time }}</td>
                <td>{{ log.message }}</td>
              </tr>
              {% endfor %}
              {% if logs|length == 0 %}
              <tr><td colspan="2">ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // ë¼ìš´ë“œ ë””í…Œì¼ í† ê¸€
  (function () {
    const summaryRows = document.querySelectorAll('.round-summary-row');
    if (!summaryRows.length) return;

    summaryRows.forEach(row => {
      row.addEventListener('click', () => {
        const key = row.getAttribute('data-round-key');
        const detailRow = document.querySelector(
          `.round-detail-row[data-round-key="${key}"]`
        );
        if (!detailRow) return;
        const current = detailRow.style.display;
        detailRow.style.display = (!current || current === 'none') ? 'table-row' : 'none';
      });
    });
  })();

  // ì•± ì²´ê²° ë™ê¸°í™” ë²„íŠ¼
  document.getElementById("sync-app-fills-btn")?.addEventListener("click", () => {
    if (!confirm("ì•± ì²´ê²°ë‚´ì—­ì„ ë™ê¸°í™”í• ê¹Œìš”?")) return;

    fetch("/sync_app_fills", { method: "POST" })
      .then(res => res.json())
      .then(data => {
        if (data.status === "ok") {
          alert("ë™ê¸°í™” ì™„ë£Œ!\n" + data.message);
          location.reload();
        } else {
          alert("ë™ê¸°í™” ì‹¤íŒ¨:\n" + data.message);
        }
      })
      .catch(err => alert("ì—ëŸ¬: " + err));
  });

  // ë‚ ì§œ ë“œë¡­ë‹¤ìš´ í•„í„° + ìš”ì•½
  (function () {
    const dailySummaries = JSON.parse('{{ daily_summaries | tojson | safe }}');
    const select = document.getElementById('trade-date-select');

    const elDate = document.getElementById('trade-date-label');
    const elCnt  = document.getElementById('trade-date-total');
    const elWin  = document.getElementById('trade-date-winrate');
    const elAvg  = document.getElementById('trade-date-avg');
    const elCum  = document.getElementById('trade-date-cum');

    function setTotalSummary() {
      elDate.textContent = 'ì „ì²´ ê¸°ê°„';
      elCnt.textContent  = '{{ summary.total_trades }}';
      elWin.textContent  = '{{ "%.2f"|format(summary.win_rate) }}%';
      elAvg.textContent  = '{{ "%.2f"|format(summary.avg_profit) }}%';
      elCum.textContent  = '{{ "%.2f"|format(summary.cum_return_pct) }}%';
    }

    if (!select || !dailySummaries.length) {
      setTotalSummary();
      return;
    }

    function updateSummary(dateValue) {
      if (dateValue === 'ALL') {
        setTotalSummary();
        return;
      }
      const found = dailySummaries.find(d => d.date === dateValue);
      if (!found) return;
      elDate.textContent = found.date;
      elCnt.textContent  = found.total_trades;
      elWin.textContent  = found.win_rate.toFixed(2) + '%';
      elAvg.textContent  = found.avg_profit.toFixed(2) + '%';
      elCum.textContent  = found.cum_return_pct.toFixed(2) + '%';
    }

    function applyFilter(dateValue) {
      const summaryRows = document.querySelectorAll('.round-summary-row');
      const detailRows  = document.querySelectorAll('.round-detail-row');

      summaryRows.forEach(row => {
        const d = row.getAttribute('data-date');
        const show = (dateValue === 'ALL' || d === dateValue);
        row.style.display = show ? 'table-row' : 'none';
      });

      detailRows.forEach(row => {
        row.style.display = 'none';
      });
    }

    select.addEventListener('change', () => {
      const v = select.value;
      updateSummary(v);
      applyFilter(v);
    });

    // ì´ˆê¸° ì ìš©
    updateSummary(select.value);
    applyFilter(select.value);
  })();

  // ì¢…ëª©ë³„ ì°¨íŠ¸ & ë§¤ë§¤ ê¸°ë¡ (ìë™ë§¤ë§¤ í˜ì´ì§€ ë‚´)
  (function () {
    const CURRENT_REGION = '{{ region }}';
    const selectEl = document.getElementById("symbol-select");
    const canvasEl = document.getElementById("symbolPriceChart");
    if (!selectEl || !canvasEl) return;

    let symbolChart = null;

    async function loadSymbolData(symbol) {
      const res = await fetch(`/symbol_data?symbol=${encodeURIComponent(symbol)}&region=${encodeURIComponent(CURRENT_REGION)}`);
      if (!res.ok) {
        throw new Error("HTTP " + res.status);
      }
      return await res.json();
    }

    function renderSymbolChart(data, symbol) {
      const ctx = canvasEl.getContext("2d");
      const statusEl = document.getElementById("symbol-chart-status");

      if (statusEl) statusEl.textContent = "";

      if (symbolChart) {
        symbolChart.destroy();
        symbolChart = null;
      }

      let priceSeries = data.candles || [];
      const tradesRaw = data.trades || [];

      // ìº”ë“¤ ì—†ìœ¼ë©´ ì¢…ë£Œ
      if (!priceSeries.length) {
        if (statusEl) statusEl.textContent = "ìº”ë“¤ ë°ì´í„°ê°€ ì—†ì–´ ì°¨íŠ¸ë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        ctx.clearRect(0, 0, canvasEl.width, canvasEl.height);
        return;
      }

      // ë§¤ë§¤ê°€ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ ì•ˆë‚´ë§Œ ë„ìš°ê³  ìº”ë“¤ë§Œ ê·¸ë¦´ì§€ ë§ì§€ëŠ” ì„ íƒ ê°€ëŠ¥
      if (!tradesRaw.length) {
        if (statusEl) statusEl.textContent = "ì´ ì¢…ëª©ì—ëŠ” ì•„ì§ ë§¤ìˆ˜/ë§¤ë„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.";
        // ìº”ë“¤ë§Œ ë³´ê³  ì‹¶ìœ¼ë©´ ì•„ë˜ return ì œê±°
        // ctx.clearRect(0, 0, canvasEl.width, canvasEl.height);
        // return;
      }

      // ì „ì²´ ìº”ë“¤ / ì „ì²´ íŠ¸ë ˆì´ë“œ ì‚¬ìš©
      const allCandles = priceSeries;
      const tradesAll = tradesRaw.map(t => {
        const ms = new Date(t.time).getTime();
        return { ...t, _ms: ms };
      });

      const candleData = allCandles.map(row => ({
        x: new Date(row.time).getTime(),
        o: Number(row.open),
        h: Number(row.high),
        l: Number(row.low),
        c: Number(row.close),
      }));

      const lows  = candleData.map(c => c.l);
      const highs = candleData.map(c => c.h);
      let yMin = Math.min(...lows);
      let yMax = Math.max(...highs);

      const range = yMax - yMin || yMin * 0.01;
      const pad   = range * 0.1;

      yMin -= pad;
      yMax += pad;

      const buyPoints = [];
      const sellPoints = [];

      tradesAll.forEach(t => {
        const labelSrc = (
          t.side ||
          t.action ||
          t.type ||
          t.reason ||
          t.exit_reason ||
          t.comment ||
          ""
        ).toString().toUpperCase();

        const hasBuyWord = (
          labelSrc.includes("BUY") ||
          labelSrc.includes("ENTRY")
        );

        const hasSellWord = (
          labelSrc.includes("SELL") ||
          labelSrc.includes("PROFIT") ||
          labelSrc.includes("CUT") ||
          labelSrc.includes("LOSS") ||
          labelSrc.includes("TP") ||
          labelSrc.includes("STOP") ||
          labelSrc.includes("ìµì ˆ") ||
          labelSrc.includes("ì†ì ˆ")
        );

        let isBuy = false;
        let isSell = false;

        if (hasSellWord && !hasBuyWord) {
          isSell = true;
        } else if (hasBuyWord && !hasSellWord) {
          isBuy = true;
        } else {
          return;
        }

        const point = {
          x: t._ms,
          y: Number(t.price),
        };

        if (isBuy)  buyPoints.push(point);
        if (isSell) sellPoints.push(point);
      });

      symbolChart = new Chart(ctx, {
        type: "candlestick",
        data: {
          datasets: [
            {
              label: symbol + " 5m",
              data: candleData,
              color: {
                up: "#22c55e",
                down: "#ef4444",
                unchanged: "#e5e7eb",
              },
              borderColor: {
                up: "#22c55e",
                down: "#ef4444",
                unchanged: "#e5e7eb",
              },
              borderWidth: 1,
            },
            {
              label: "BUY",
              type: "scatter",
              data: buyPoints,
              pointRadius: 4,
              backgroundColor: "#22c55e",
              borderColor: "#22c55e",
            },
            {
              label: "SELL",
              type: "scatter",
              data: sellPoints,
              pointRadius: 4,
              backgroundColor: "#f97316",
              borderColor: "#f97316",
            },
          ],
        },
        options: {
          parsing: false,
          plugins: {
            legend: {
              labels: { color: "#e5e7eb" },
            },
          },
          scales: {
            x: {
              type: "time",
              time: {
                unit: "hour",
                tooltipFormat: "MM-dd HH:mm",
              },
              ticks: { color: "#9ca3af" },
              grid: { color: "rgba(148, 163, 184, 0.1)" },
            },
            y: {
              position: "right",
              min: yMin,
              max: yMax,
              ticks: { color: "#9ca3af" },
              grid: { color: "rgba(148, 163, 184, 0.1)" },
            },
          },
        },
      });

      console.log(
        `[${symbol}] candles: ${candleData.length}, trades: ${tradesAll.length}, BUY: ${buyPoints.length}, SELL: ${sellPoints.length}`
      );
    }

    selectEl.addEventListener("change", async () => {
      const sym = selectEl.value;
      if (!sym) {
        if (symbolChart) {
          symbolChart.destroy();
          symbolChart = null;
        }
        return;
      }

      try {
        const data = await loadSymbolData(sym);
        renderSymbolChart(data, sym);
      } catch (err) {
        console.error(err);
        alert("ì‹¬ë³¼ ì°¨íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    });

    // í˜ì´ì§€ ì§„ì… ì‹œ, ê¸°ë³¸ ì„ íƒê°’ì´ ìˆìœ¼ë©´ ìë™ ë¡œë”©
    if (selectEl.value) {
      loadSymbolData(selectEl.value)
        .then(data => renderSymbolChart(data, selectEl.value))
        .catch(err => console.error(err));
    }
  })();
</script>
{% endblock %}
