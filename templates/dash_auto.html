{% extends "base.html" %}

{% block content %}
<div class="layout">
  <h1>âš™ï¸ ìë™ë§¤ë§¤</h1>
  
  <div style="display: flex; flex-direction: row; justify-content: space-between; align-items: baseline;">
    <div class="card-header">ğŸ“‘ íŠ¸ë ˆì´ë“œ (Positions)</div>
    <div class="trade-date-summary">
      <span id="trade-date-label">-</span> Â·
      íŠ¸ë ˆì´ë“œ <strong id="trade-date-total">0</strong>ê±´ Â·
      ìŠ¹ë¥  <strong id="trade-date-winrate">0%</strong> Â·
      í‰ê·  <strong id="trade-date-avg">0%</strong> Â·
      ëˆ„ì  <strong id="trade-date-cum">0%</strong>
    </div>
  </div>

  <!-- 1) íŠ¸ë ˆì´ë“œ ì„¹ì…˜ -->
  <div class="card" style="max-height: 600px; overflow-y: auto;">
    <div style="display:flex; justify-content:end; align-items:center; margin-bottom:8px; gap:12px; flex-wrap:wrap; position: sticky; top: 0; background: #1e293b; z-index: 10; padding-bottom: 10px;">
      <button id="sync-app-fills-btn" class="sync-btn">ì•± ì²´ê²° ë™ê¸°í™”</button>
      <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
        {% if daily_summaries and daily_summaries|length > 0 %}
        <select id="trade-date-select" class="trade-date-select">
          <option value="ALL">ì „ì²´ ê¸°ê°„</option>
          {% for d in daily_summaries %}
          <option value="{{ d.date }}" {% if loop.first %}selected{% endif %}>
            {{ d.date }} ({{ d.total_trades }}ê±´)
          </option>
          {% endfor %}
        </select>
        {% endif %}
      </div>
    </div>

    <div class="scroll-box">
      <table>
        <thead>
          <tr>
            <th>ì§„ì… ì‹œê°„</th>
            <th>ì²­ì‚° ì‹œê°„</th>
            <th>ì¢…ëª©</th>
            <th>ìƒíƒœ</th>
            <th>ì§„ì… ìˆ˜ëŸ‰</th>
            <th>ì§„ì… í‰ê· ê°€</th>
            <th>ì‹¤í˜„ ìˆ˜ìµë¥ (%)</th>
          </tr>
        </thead>
        <tbody>
          {% for rt in round_trades %}
            {% set key = rt.symbol ~ '__' ~ rt.round_id %}

            <!-- ìš”ì•½ í–‰ -->
            <tr class="round-summary-row"
                data-round-key="{{ key }}"
                data-date="{{ rt.date }}"
                style="cursor:pointer;">
              <td>{{ rt.entry_time }}</td>
              <td>{{ rt.exit_time if rt.exit_time else '-' }}</td>
              <td>{{ rt.symbol }}</td>
              <td>
                {% if rt.status == "OPEN" %}
                  <span class="badge badge-status-open">OPEN</span>
                {% else %}
                  <span class="badge badge-status-closed">CLOSED</span>
                {% endif %}
              </td>
              <td>{{ rt.entry_qty }}</td>
              <td>{{ "%.2f"|format(rt.entry_price) }}</td>
              <td>
                {% if rt.realized_profit_pct > 0 %}
                    <span style="color: #4ade80;">+{{ "%.2f"|format(rt.realized_profit_pct) }}</span>
                {% elif rt.realized_profit_pct < 0 %}
                    <span style="color: #f87171;">{{ "%.2f"|format(rt.realized_profit_pct) }}</span>
                {% else %}
                    0.00
                {% endif %}
              </td>
            </tr>

            <!-- ë””í…Œì¼ í–‰ (Positions êµ¬ì¡°ì— ë§ì¶° ìˆ˜ì •ë¨) -->
            <tr class="round-detail-row"
                data-round-key="{{ key }}"
                data-date="{{ rt.date }}"
                style="display:none;">
              <td colspan="7">
                <div style="border-top:1px solid #334155; margin-top:6px; padding:10px; background-color: #0f172a;">
                    <!-- ì½”ë©˜íŠ¸ í‘œì‹œ ì˜ì—­ -->
                    <div style="margin-bottom: 10px; font-size: 12px; color: #cbd5e1;">
                        <strong>ğŸ“ ì „ëµ ì½”ë©˜íŠ¸</strong>
                        <div style="margin-top: 4px; padding-left: 8px; border-left: 2px solid #64748b;">
                            {% if rt.entry_comment %}
                                <div><span style="color: #94a3b8;">[ì§„ì…]</span> {{ rt.entry_comment }}</div>
                            {% endif %}
                            {% if rt.exit_comment %}
                                <div><span style="color: #94a3b8;">[ì²­ì‚°]</span> {{ rt.exit_comment }}</div>
                            {% endif %}
                            {% if not rt.entry_comment and not rt.exit_comment %}
                                <span style="color: #64748b;">ë“±ë¡ëœ ì½”ë©˜íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- ì„¸ë¶€ ì²´ê²° ë‚´ì—­ (ê°€ìƒ ìƒì„± ë°ì´í„°) -->
                    {% if key in round_details and round_details[key]|length > 0 %}
                    <table style="width:100%; font-size:11px;">
                        <thead>
                        <tr>
                            <th style="width: 20%;">ì‹œê°„</th>
                            <th style="width: 20%;">í–‰ë™</th>
                            <th style="width: 20%;">ê°€ê²©</th>
                            <th style="width: 20%;">ìˆ˜ëŸ‰</th>
                            <th style="width: 20%;">ML ì ìˆ˜</th>
                        </tr>
                        </thead>
                        <tbody>
                            {% for d in round_details[key] %}
                            <tr>
                            <td>{{ d.time }}</td>
                            <td>{{ d.type }}</td>
                            <td>{{ "%.2f"|format(d.price) }}</td>
                            <td>{{ d.qty }}</td>
                            <td>{{ "%.3f"|format(d.ml_proba) if d.ml_proba is not none else '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% endif %}
                </div>
              </td>
            </tr>
          {% endfor %}

          {% if round_trades|length == 0 %}
            <tr><td colspan="7" style="text-align:center; padding: 20px;">í‘œì‹œí•  íŠ¸ë ˆì´ë“œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- 2) ì¢…ëª©ë³„ ì°¨íŠ¸ & ë§¤ë§¤ ê¸°ë¡ -->
  <div style="margin-top: 24px;">
    <div style="display: flex; flex-direction: row; justify-content: space-between; align-items: baseline; padding: 0 10px; margin-bottom: 10px;">
      <div class="card-header" style="margin-bottom: 0;">ğŸ“ˆ ì¢…ëª©ë³„ ì°¨íŠ¸ & ë§¤ë§¤ ê¸°ë¡</div>
      <div>
        <label style="font-size:12px; color:#9da4c2; margin-right:6px;">ì¢…ëª© ì„ íƒ</label>
        <select id="symbol-select"
                style="background:#020617; color:#e5e7eb; border:1px solid #374151; border-radius:999px; padding:4px 10px; font-size:12px;">
          <option value="">- ì¢…ëª©ì„ ì„ íƒí•˜ì„¸ìš” -</option>
          {% for sym in symbols_with_data %}
            <option value="{{ sym }}">{{ sym }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
      
    <section class="card">
      <div style="height:600px; position: relative;">
        <canvas id="symbolPriceChart"></canvas>
      </div>

      <p id="symbol-chart-status" style="font-size:11px; color:#f97316; margin-top:4px; min-height: 16px;"></p>

      <p style="font-size:11px; color:#6b7280; margin-top:4px;">
        Â· ìº”ë“¤ì€ ìµœê·¼ 500ê°œ(5ë¶„ë´‰)ê°€ í‘œì‹œë©ë‹ˆë‹¤. / ì´ˆë¡ ì : ì§„ì…(BUY) / ì£¼í™© ì : ì²­ì‚°/ë§¤ë„(SELL)
      </p>
    </section>
  </div>

  <!-- 3) AI ì˜ì‚¬ê²°ì • ë¡œê·¸ -->
  <div style="margin-top: 20px;">
    <div class="card-header">ğŸ¤– AI ì˜ì‚¬ê²°ì • ë¡œê·¸ (ìµœê·¼ 200ê°œ)</div>
    <div class="card">
      <div class="scroll-box">
        <table>
          <thead>
            <tr>
              <th>ì‹œê°„</th>
              <th>ì‹œì¥</th>
              <th>ì¢…ëª©</th>
              <th>ê°€ê²©</th>
              <th>ë£°ì‹ í˜¸</th>
              <th>ML ì ìˆ˜</th>
              <th>ì§„ì…í—ˆìš©</th>
              <th>ë³´ìœ ì¤‘</th>
              <th>ë¹„ê³ </th>
            </tr>
          </thead>
          <tbody>
            {% for s in signals %}
            <tr>
              <td>{{ s.time }}</td>
              <td>{{ s.region }}</td>
              <td>{{ s.symbol }}</td>
              <td>{{ "%.2f"|format(s.price) }}</td>
              <td>{% if s.entry_signal %}âœ…{% else %}âŒ{% endif %}</td>
              <td>{{ "%.3f"|format(s.ml_proba) if s.ml_proba is not none else '-' }}</td>
              <td>
                {% if s.entry_allowed is none %} - {% elif s.entry_allowed %} âœ… {% else %} âŒ {% endif %}
              </td>
              <td>{% if s.has_stock %}ë³´ìœ {% else %}-{% endif %}</td>
              <td>{{ s.note }}</td>
            </tr>
            {% endfor %}
            {% if signals|length == 0 %}
            <tr><td colspan="9" style="text-align:center;">ê¸°ë¡ëœ ì‹ í˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 4) ì‹¤í–‰ ë¡œê·¸ -->
  <div style="margin-top: 20px;">
    <div class="card-header">ğŸ“ ì‹¤í–‰ ë¡œê·¸ (ìµœê·¼ 200ê°œ)</div>
    <div class="card scroll-box" style="max-height: 300px;">
        <table>
        <thead>
            <tr>
            <th style="width: 180px;">ì‹œê°„</th>
            <th>ë©”ì‹œì§€</th>
            </tr>
        </thead>
        <tbody>
            {% for log in logs %}
            <tr>
            <td>{{ log.time }}</td>
            <td>{{ log.message }}</td>
            </tr>
            {% endfor %}
            {% if logs|length == 0 %}
            <tr><td colspan="2" style="text-align:center;">ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
            {% endif %}
        </tbody>
        </table>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // 1. ë¼ìš´ë“œ ë””í…Œì¼ í† ê¸€
  (function () {
    const summaryRows = document.querySelectorAll('.round-summary-row');
    summaryRows.forEach(row => {
      row.addEventListener('click', () => {
        const key = row.getAttribute('data-round-key');
        const detailRow = document.querySelector(`.round-detail-row[data-round-key="${key}"]`);
        if (detailRow) {
          const current = detailRow.style.display;
          detailRow.style.display = (!current || current === 'none') ? 'table-row' : 'none';
        }
      });
    });
  })();

  // 2. ì•± ì²´ê²° ë™ê¸°í™” ë²„íŠ¼
  document.getElementById("sync-app-fills-btn")?.addEventListener("click", () => {
    if (!confirm("ì•± ì²´ê²°ë‚´ì—­ì„ DBì™€ ë™ê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    fetch("/sync-app-trades", { method: "POST" })
      .then(res => res.json())
      .then(data => {
        if (data.ok) {
          alert("ë™ê¸°í™” ìš”ì²­ ì„±ê³µ!");
          location.reload();
        } else {
          alert("ë™ê¸°í™” ì‹¤íŒ¨: " + (data.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
        }
      })
      .catch(err => alert("ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬: " + err));
  });

  // 3. ë‚ ì§œë³„ ìš”ì•½ ë° í•„í„°ë§
  (function () {
    const dailySummaries = JSON.parse('{{ daily_summaries | tojson | safe }}');
    const select = document.getElementById('trade-date-select');

    // ìƒë‹¨ ë¼ë²¨ ì—˜ë¦¬ë¨¼íŠ¸
    const elDate = document.getElementById('trade-date-label');
    const elCnt  = document.getElementById('trade-date-total');
    const elWin  = document.getElementById('trade-date-winrate');
    const elAvg  = document.getElementById('trade-date-avg');
    const elCum  = document.getElementById('trade-date-cum');

    const totalStats = {
      cnt: '{{ summary.total_trades }}',
      win: '{{ "%.2f"|format(summary.win_rate) }}',
      avg: '{{ "%.2f"|format(summary.avg_profit) }}',
      cum: '{{ "%.2f"|format(summary.cum_return_pct) }}'
    };

    function setDisplay(stats, dateLabel) {
      elDate.textContent = dateLabel;
      elCnt.textContent  = stats.cnt;
      elWin.textContent  = stats.win + '%';
      elAvg.textContent  = stats.avg + '%';
      elCum.textContent  = stats.cum + '%';
    }

    if (!select) {
      setDisplay(totalStats, 'ì „ì²´ ê¸°ê°„');
      return;
    }

    function applyFilter(dateValue) {
      const summaryRows = document.querySelectorAll('.round-summary-row');
      const detailRows  = document.querySelectorAll('.round-detail-row');

      summaryRows.forEach(row => {
        const d = row.getAttribute('data-date');
        const show = (dateValue === 'ALL' || d === dateValue);
        row.style.display = show ? 'table-row' : 'none';
      });

      detailRows.forEach(row => {
        row.style.display = 'none';
      });

      if (dateValue === 'ALL') {
        setDisplay(totalStats, 'ì „ì²´ ê¸°ê°„');
      } else {
        const found = dailySummaries.find(d => d.date === dateValue);
        if (found) {
          setDisplay({
            cnt: found.total_trades,
            win: found.win_rate.toFixed(2),
            avg: found.avg_profit.toFixed(2),
            cum: found.cum_return_pct.toFixed(2)
          }, found.date);
        } else {
          setDisplay({ cnt: 0, win: '0.00', avg: '0.00', cum: '0.00' }, dateValue);
        }
      }
    }

    select.addEventListener('change', () => {
      applyFilter(select.value);
    });

    applyFilter(select.value);
  })();

  // 4. ì¢…ëª©ë³„ ì°¨íŠ¸ (Chart.js)
  (function () {
    const CURRENT_REGION = '{{ region }}';
    const selectEl = document.getElementById("symbol-select");
    const canvasEl = document.getElementById("symbolPriceChart");
    const statusEl = document.getElementById("symbol-chart-status");

    if (!selectEl || !canvasEl) return;

    let symbolChart = null;

    async function loadSymbolData(symbol) {
      const url = `/symbol_data?symbol=${encodeURIComponent(symbol)}&region=${encodeURIComponent(CURRENT_REGION)}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error("Chart Data Fetch Error: " + res.status);
      return await res.json();
    }

    function renderSymbolChart(data, symbol) {
      const ctx = canvasEl.getContext("2d");
      
      if (statusEl) statusEl.textContent = "";

      if (symbolChart) {
        symbolChart.destroy();
        symbolChart = null;
      }

      const candles = data.candles || [];
      const trades = data.trades || [];

      if (candles.length === 0) {
        if (statusEl) statusEl.textContent = "âš ï¸ í•´ë‹¹ ì¢…ëª©ì˜ ìº”ë“¤ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
        ctx.clearRect(0, 0, canvasEl.width, canvasEl.height);
        return;
      }

      // ìº”ë“¤ ë°ì´í„° ë³€í™˜
      const candleData = candles.map(c => ({
        x: new Date(c.time).getTime(),
        o: c.open,
        h: c.high,
        l: c.low,
        c: c.close
      }));

      // ë§¤ë§¤ ë§ˆì»¤ ë°ì´í„° ë³€í™˜
      const buyPoints = [];
      const sellPoints = [];

      trades.forEach(t => {
        const type = (t.type || "").toUpperCase();
        const point = {
            x: new Date(t.time).getTime(),
            y: t.price
        };

        if (type === 'BUY') {
            buyPoints.push(point);
        } else if (type === 'SELL') {
            sellPoints.push(point);
        }
      });

      if (trades.length === 0 && statusEl) {
        statusEl.textContent = "â„¹ï¸ ì´ ì¢…ëª©ì˜ ì°¨íŠ¸ ê¸°ê°„ ë‚´ ë§¤ë§¤ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.";
      }

      symbolChart = new Chart(ctx, {
        type: "candlestick",
        data: {
          datasets: [
            {
              label: symbol,
              data: candleData,
              color: { up: "#22c55e", down: "#ef4444", unchanged: "#94a3b8" },
              borderColor: { up: "#22c55e", down: "#ef4444", unchanged: "#94a3b8" },
              borderWidth: 1,
              order: 2
            },
            {
              label: "ì§„ì…(BUY)",
              type: "scatter",
              data: buyPoints,
              pointStyle: 'circle',
              pointRadius: 6,
              pointHoverRadius: 8,
              backgroundColor: "#22c55e", // Green
              borderColor: "#ffffff",
              borderWidth: 1,
              order: 1
            },
            {
              label: "ì²­ì‚°/ë§¤ë„(SELL)",
              type: "scatter",
              data: sellPoints,
              pointStyle: 'triangle',
              pointRadius: 6,
              pointHoverRadius: 8,
              backgroundColor: "#f97316", // Orange
              borderColor: "#ffffff",
              borderWidth: 1,
              order: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
                labels: { color: '#cbd5e1' }
            },
            tooltip: {
                mode: 'index',
                intersect: false
            }
          },
          scales: {
            x: {
              type: 'time',
              time: {
                unit: 'minute',
                displayFormats: { minute: 'MM-dd HH:mm' },
                tooltipFormat: 'yyyy-MM-dd HH:mm'
              },
              grid: { color: '#334155' },
              ticks: { color: '#94a3b8' }
            },
            y: {
              position: 'right',
              grid: { color: '#334155' },
              ticks: { color: '#94a3b8' }
            }
          }
        }
      });
    }

    selectEl.addEventListener("change", async () => {
      const sym = selectEl.value;
      if (!sym) {
        if (symbolChart) {
          symbolChart.destroy();
          symbolChart = null;
        }
        return;
      }
      try {
        const data = await loadSymbolData(sym);
        renderSymbolChart(data, sym);
      } catch (e) {
        console.error(e);
        alert("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ì°¨íŠ¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      }
    });

    if (selectEl.value) {
        selectEl.dispatchEvent(new Event('change'));
    }
  })();
</script>
{% endblock %}